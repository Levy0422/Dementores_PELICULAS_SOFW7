{% extends "blogapp/base.html" %}
{% load static %}

{% block content %}
<!-- CONTENEDOR PRINCIPAL -->
<!-- 
  Diseño responsivo con: 
  - Ancho máximo (max-w-md) 
  - Centrado (mx-auto)
  - Fondo claro/oscuro (bg-white/dark:bg-gray-800)
  - Sombra y bordes redondeados
-->
<div class="max-w-md mx-auto mt-10 bg-white dark:bg-gray-800 p-8 rounded-lg shadow-lg animate-fade-in">
  <!-- TÍTULO DEL FORMULARIO -->
  <h2 class="text-2xl font-semibold text-center mb-6 text-gray-900 dark:text-white">Registro</h2>
  
  <!-- FORMULARIO -->
  <!-- 
    Método: POST (envío seguro)
    ID: registerForm (para JavaScript)
  -->
  <form method="POST" class="space-y-6" id="registerForm">
    {% csrf_token %}  <!-- Protección contra CSRF -->
    
    <!-- CAMPO NOMBRE DE USUARIO -->
    <div class="space-y-2">
      <label for="id_username" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
        Nombre de usuario
      </label>
      <input type="text" name="username" id="id_username" required 
             class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
             placeholder="Tu nombre de usuario">
      <!-- REGLAS PARA EL USUARIO -->
      <div class="text-xs text-gray-500 dark:text-gray-400 bg-gray-50 dark:bg-gray-700 p-2 rounded">
        <p>• Máximo 150 caracteres</p>
        <p>• Solo letras, números y @/./+/-/_</p>
      </div>
    </div>
    
    <!-- CAMPO CONTRASEÑA -->
    <div class="space-y-2">
      <label for="id_password1" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
        Contraseña
      </label>
      <input type="password" name="password1" id="id_password1" required 
             class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
             placeholder="Tu contraseña"
             oninput="validatePassword()">  <!-- Valida al escribir -->
      <!-- REQUISITOS DE CONTRASEÑA -->
      <div class="text-xs text-gray-500 dark:text-gray-400 bg-gray-50 dark:bg-gray-700 p-2 rounded">
        <p id="lengthCheck" class="flex items-start"><span class="mr-1">•</span> <span>Mínimo 8 caracteres</span></p>
        <p id="numberCheck" class="flex items-start"><span class="mr-1">•</span> <span>Debe contener al menos un número</span></p>
        <p id="commonCheck" class="flex items-start"><span class="mr-1">•</span> <span>No puede ser una contraseña común</span></p>
        <p id="numericCheck" class="flex items-start"><span class="mr-1">•</span> <span>No puede ser completamente numérica</span></p>
        <p id="personalCheck" class="flex items-start"><span class="mr-1">•</span> <span>No puede ser similar a tu información personal</span></p>
      </div>
    </div>
    
    <!-- CONFIRMACIÓN DE CONTRASEÑA -->
    <div class="space-y-2">
      <label for="id_password2" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
        Confirmar contraseña
      </label>
      <input type="password" name="password2" id="id_password2" required 
             class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
             placeholder="Repite tu contraseña"
             oninput="checkPasswordMatch()">  <!-- Verifica coincidencia -->
      <!-- MENSAJES DE VALIDACIÓN -->
      <p id="passwordMatch" class="text-xs text-gray-500 dark:text-gray-400">Introduce la misma contraseña para verificación</p>
      <p id="passwordError" class="text-xs text-red-500 hidden"></p>
    </div>
    
    <!-- BOTÓN DE ENVÍO -->
    <!-- Se deshabilita si hay errores -->
    <button type="submit" id="submitBtn" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-md transition duration-200 shadow disabled:opacity-50 disabled:cursor-not-allowed">
      Crear cuenta
    </button>
  </form>
  
  <!-- ENLACE A INICIO DE SESIÓN -->
  <p class="mt-6 text-sm text-center text-gray-600 dark:text-gray-300">
    ¿Ya tienes cuenta? <a href="{% url 'blogapp:login' %}" class="text-blue-500 hover:underline">Inicia sesión</a>
  </p>
</div>

<!-- SCRIPTS DE VALIDACIÓN -->
<script>
  // LISTA DE CONTRASEÑAS DÉBILES (no permitidas)
  const commonPasswords = [
    '123456', 'password', '12345678', 'qwerty', '123456789', 
    '12345', '1234', '111111', '1234567', 'dragon',
    // ... (lista completa en el código original)
  ];

  /**
   * VALIDA LA CONTRASEÑA EN TIEMPO REAL
   * Verifica 5 requisitos de seguridad
   * Actualiza la interfaz con feedback visual
   */
  function validatePassword() {
    const password = document.getElementById('id_password1').value;
    const username = document.getElementById('id_username').value;
    
    // Elementos UI para mostrar estado
    const lengthCheck = document.getElementById('lengthCheck');
    const numberCheck = document.getElementById('numberCheck');
    const commonCheck = document.getElementById('commonCheck');
    const numericCheck = document.getElementById('numericCheck');
    const personalCheck = document.getElementById('personalCheck');
    const submitBtn = document.getElementById('submitBtn');
    
    let isValid = true;
    
    // 1. Longitud mínima (8 caracteres)
    const isLengthValid = password.length >= 8;
    updateValidationUI(lengthCheck, isLengthValid, 'Mínimo 8 caracteres');
    if (!isLengthValid) isValid = false;
    
    // 2. Contiene al menos un número
    const hasNumber = /\d/.test(password);
    updateValidationUI(numberCheck, hasNumber, 'Debe contener al menos un número');
    if (!hasNumber) isValid = false;
    
    // 3. No es completamente numérica
    const isNumericValid = !/^\d+$/.test(password);
    updateValidationUI(numericCheck, isNumericValid, 'No puede ser completamente numérica');
    if (!isNumericValid) isValid = false;
    
    // 4. No está en lista de contraseñas comunes
    const isCommonValid = !commonPasswords.includes(password.toLowerCase());
    updateValidationUI(commonCheck, isCommonValid, 'No puede ser una contraseña común');
    if (!isCommonValid) isValid = false;
    
    // 5. No es similar al nombre de usuario
    const isPersonalValid = !password.toLowerCase().includes(username.toLowerCase()) && username.toLowerCase() !== password.toLowerCase();
    updateValidationUI(personalCheck, isPersonalValid, 'No puede ser similar a tu información personal');
    if (!isPersonalValid) isValid = false;
    
    // Actualiza estado del botón
    submitBtn.disabled = !isValid;
    
    // Verifica también coincidencia de contraseñas
    checkPasswordMatch();
    return isValid;
  }
  
  /**
   * ACTUALIZA LA INTERFAZ DE VALIDACIÓN
   * @param element - Elemento HTML a modificar
   * @param isValid - Si cumple el requisito
   * @param defaultText - Texto a mostrar
   */
  function updateValidationUI(element, isValid, defaultText) {
    if (isValid) {
      element.classList.add('text-green-500');
      element.classList.remove('text-gray-500', 'text-red-500');
    } else {
      element.classList.add('text-red-500');
      element.classList.remove('text-gray-500', 'text-green-500');
    }
    element.querySelector('span:last-child').textContent = defaultText;
  }
  
  /**
   * VERIFICA QUE LAS CONTRASEÑAS COINCIDAN
   * Muestra mensaje de error si no coinciden
   */
  function checkPasswordMatch() {
    const password1 = document.getElementById('id_password1').value;
    const password2 = document.getElementById('id_password2').value;
    const matchText = document.getElementById('passwordMatch');
    const errorText = document.getElementById('passwordError');
    const submitBtn = document.getElementById('submitBtn');
    
    // Si el campo está vacío, muestra texto neutral
    if (password2.length === 0) {
      matchText.classList.remove('hidden');
      errorText.classList.add('hidden');
      return true;
    }
    
    const passwordsMatch = password1 === password2;
    
    if (passwordsMatch) {
      // Coinciden: muestra en verde
      matchText.classList.remove('hidden');
      matchText.classList.add('text-green-500');
      matchText.classList.remove('text-gray-500');
      errorText.classList.add('hidden');
    } else {
      // No coinciden: muestra error
      matchText.classList.add('hidden');
      errorText.classList.remove('hidden');
      errorText.textContent = 'Las contraseñas no coinciden';
    }
    
    // Actualiza estado del botón
    submitBtn.disabled = !passwordsMatch || !validatePassword();
    return passwordsMatch;
  }
  
  // VALIDACIÓN ANTES DE ENVIAR (evita envío con errores)
  document.getElementById('registerForm').addEventListener('submit', function(e) {
    if (!validatePassword() || !checkPasswordMatch()) {
      e.preventDefault();
      alert('Por favor, corrige los errores en el formulario antes de enviar.');
    }
  });
  
  // VALIDACIÓN INICIAL AL CARGAR LA PÁGINA
  document.addEventListener('DOMContentLoaded', function() {
    validatePassword();
    checkPasswordMatch();
  });
</script>

<!-- ESTILOS PARA MODO OSCURO -->
<style>
  .dark .text-green-500 {
    color: #34d399;  /* Verde para modo oscuro */
  }
  .dark .text-red-500 {
    color: #f87171;  /* Rojo para modo oscuro */
  }
</style>
{% endblock %}