{% extends "blogapp/base.html" %}
{% load static %}

{% block content %}
<div class="max-w-md mx-auto mt-10 bg-white dark:bg-gray-800 p-8 rounded-lg shadow-lg animate-fade-in">
  <h2 class="text-2xl font-semibold text-center mb-6 text-gray-900 dark:text-white">Registro</h2>
  <form method="POST" class="space-y-6" id="registerForm">
    {% csrf_token %}
    
    <!-- Campo Username -->
    <div class="space-y-2">
      <label for="id_username" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
        Nombre de usuario
      </label>
      <input type="text" name="username" id="id_username" required 
             class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
             placeholder="Tu nombre de usuario">
      <div class="text-xs text-gray-500 dark:text-gray-400 bg-gray-50 dark:bg-gray-700 p-2 rounded">
        <p>• Máximo 150 caracteres</p>
        <p>• Solo letras, números y @/./+/-/_</p>
      </div>
    </div>
    
    <!-- Campo Password -->
    <div class="space-y-2">
      <label for="id_password1" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
        Contraseña
      </label>
      <input type="password" name="password1" id="id_password1" required 
             class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
             placeholder="Tu contraseña"
             oninput="validatePassword()">
      <div class="text-xs text-gray-500 dark:text-gray-400 bg-gray-50 dark:bg-gray-700 p-2 rounded">
        <p id="lengthCheck" class="flex items-start"><span class="mr-1">•</span> <span>Mínimo 8 caracteres</span></p>
        <p id="numberCheck" class="flex items-start"><span class="mr-1">•</span> <span>Debe contener al menos un número</span></p>
        <p id="commonCheck" class="flex items-start"><span class="mr-1">•</span> <span>No puede ser una contraseña común</span></p>
        <p id="numericCheck" class="flex items-start"><span class="mr-1">•</span> <span>No puede ser completamente numérica</span></p>
        <p id="personalCheck" class="flex items-start"><span class="mr-1">•</span> <span>No puede ser similar a tu información personal</span></p>
      </div>
    </div>
    
    <!-- Campo Password confirmation -->
    <div class="space-y-2">
      <label for="id_password2" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
        Confirmar contraseña
      </label>
      <input type="password" name="password2" id="id_password2" required 
             class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
             placeholder="Repite tu contraseña"
             oninput="checkPasswordMatch()">
      <p id="passwordMatch" class="text-xs text-gray-500 dark:text-gray-400">Introduce la misma contraseña para verificación</p>
      <p id="passwordError" class="text-xs text-red-500 hidden"></p>
    </div>
    
    <button type="submit" id="submitBtn" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-md transition duration-200 shadow disabled:opacity-50 disabled:cursor-not-allowed">
      Crear cuenta
    </button>
  </form>
  <p class="mt-6 text-sm text-center text-gray-600 dark:text-gray-300">
    ¿Ya tienes cuenta? <a href="{% url 'blogapp:login' %}" class="text-blue-500 hover:underline">Inicia sesión</a>
  </p>
</div>

<script>
  // Lista más extensa de contraseñas comunes
  const commonPasswords = [
    '123456', 'password', '12345678', 'qwerty', '123456789', 
    '12345', '1234', '111111', '1234567', 'dragon', 
    '123123', 'baseball', 'abc123', 'football', 'monkey',
    'letmein', 'shadow', 'master', '666666', 'qwertyuiop',
    '123321', 'mustang', '1234567890', 'michael', '654321',
    'superman', '1qaz2wsx', '7777777', '121212', '000000',
    'qazwsx', '123qwe', 'killer', 'trustno1', 'jordan',
    'jennifer', 'zxcvbnm', 'asdfgh', 'hunter', 'buster',
    'soccer', 'harley', 'batman', 'andrew', 'tigger',
    'sunshine', 'iloveyou', '2000', 'charlie', 'robert',
    'thomas', 'hockey', 'ranger', 'daniel', 'starwars',
    'klaster', '112233', 'george', 'computer', 'michelle',
    'jessica', 'pepper', '1111', 'zxcvbn', '555555',
    '11111111', '131313', 'freedom', '777777', 'pass',
    'maggie', '159753', 'aaaaaa', 'ginger', 'princess',
    'joshua', 'cheese', 'amanda', 'summer', 'love',
    'ashley', 'nicole', 'chelsea', 'biteme', 'matthew',
    'access', 'yankees', '987654321', 'dallas', 'austin',
    'thunder', 'taylor', 'matrix', 'mobilemail', 'mom',
    'monitor', 'monitoring', 'montana', 'moon', 'moscow'
  ];

  function validatePassword() {
    const password = document.getElementById('id_password1').value;
    const username = document.getElementById('id_username').value;
    const lengthCheck = document.getElementById('lengthCheck');
    const numberCheck = document.getElementById('numberCheck');
    const commonCheck = document.getElementById('commonCheck');
    const numericCheck = document.getElementById('numericCheck');
    const personalCheck = document.getElementById('personalCheck');
    const submitBtn = document.getElementById('submitBtn');
    
    let isValid = true;
    
    // Validar longitud mínima (8 caracteres)
    const isLengthValid = password.length >= 8;
    updateValidationUI(lengthCheck, isLengthValid, 'Mínimo 8 caracteres');
    if (!isLengthValid) isValid = false;
    
    // Validar que contenga al menos un número
    const hasNumber = /\d/.test(password);
    updateValidationUI(numberCheck, hasNumber, 'Debe contener al menos un número');
    if (!hasNumber) isValid = false;
    
    // Validar que no sea completamente numérica
    const isNumericValid = !/^\d+$/.test(password);
    updateValidationUI(numericCheck, isNumericValid, 'No puede ser completamente numérica');
    if (!isNumericValid) isValid = false;
    
    // Validar contraseña común
    const isCommonValid = !commonPasswords.includes(password.toLowerCase());
    updateValidationUI(commonCheck, isCommonValid, 'No puede ser una contraseña común');
    if (!isCommonValid) isValid = false;
    
    // Validar que no sea similar al nombre de usuario
    const isPersonalValid = !password.toLowerCase().includes(username.toLowerCase()) && username.toLowerCase() !== password.toLowerCase();
    updateValidationUI(personalCheck, isPersonalValid, 'No puede ser similar a tu información personal');
    if (!isPersonalValid) isValid = false;
    
    // Actualizar estado del botón
    submitBtn.disabled = !isValid;
    
    checkPasswordMatch();
    return isValid;
  }
  
  function updateValidationUI(element, isValid, defaultText) {
    if (isValid) {
      element.classList.add('text-green-500');
      element.classList.remove('text-gray-500', 'text-red-500');
    } else {
      element.classList.add('text-red-500');
      element.classList.remove('text-gray-500', 'text-green-500');
    }
    element.querySelector('span:last-child').textContent = defaultText;
  }
  
  function checkPasswordMatch() {
    const password1 = document.getElementById('id_password1').value;
    const password2 = document.getElementById('id_password2').value;
    const matchText = document.getElementById('passwordMatch');
    const errorText = document.getElementById('passwordError');
    const submitBtn = document.getElementById('submitBtn');
    
    if (password2.length === 0) {
      matchText.classList.remove('hidden');
      errorText.classList.add('hidden');
      return true;
    }
    
    const passwordsMatch = password1 === password2;
    
    if (passwordsMatch) {
      matchText.classList.remove('hidden');
      matchText.classList.add('text-green-500');
      matchText.classList.remove('text-gray-500');
      errorText.classList.add('hidden');
    } else {
      matchText.classList.add('hidden');
      errorText.classList.remove('hidden');
      errorText.textContent = 'Las contraseñas no coinciden';
    }
    
    submitBtn.disabled = !passwordsMatch || !validatePassword();
    return passwordsMatch;
  }
  
  // Validar antes de enviar el formulario
  document.getElementById('registerForm').addEventListener('submit', function(e) {
    if (!validatePassword() || !checkPasswordMatch()) {
      e.preventDefault();
      alert('Por favor, corrige los errores en el formulario antes de enviar.');
    }
  });
  
  // Validación inicial al cargar la página
  document.addEventListener('DOMContentLoaded', function() {
    validatePassword();
    checkPasswordMatch();
  });
</script>

<style>
  .dark .text-green-500 {
    color: #34d399;
  }
  .dark .text-red-500 {
    color: #f87171;
  }
</style>
{% endblock %}