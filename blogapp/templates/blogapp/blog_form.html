{% extends 'base.html' %}
{% load widget_tweaks %}

{% block content %}
<h1 class="text-2xl font-bold mb-6 text-white">Publicar Entrada</h1>

<form method="post" enctype="multipart/form-data" action="{% url 'blogapp:add_blog' %}">
  {% csrf_token %}
  {{ form.non_field_errors }}

  <div class="flex flex-col lg:flex-row gap-8 w-full">
    <!-- Columna izquierda - Imagen 50% -->
    <div class="w-full lg:w-1/2">
      <label class="block font-medium mb-2 text-black dark:text-white">
        Imagen <span class="text-red-600">*</span>
      </label>
      <div class="border-2 border-dashed border-gray-600 rounded-lg p-4 flex flex-col items-center justify-center h-96">
        <label for="id_image" class="flex flex-col items-center justify-center w-full cursor-pointer">
          <svg class="w-10 h-10 text-gray-400 mb-2" fill="currentColor" viewBox="0 0 20 20">
            <path d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V7.828a2 2 0 00-.586-1.414l-4.828-4.828A2 2 0 0011.172 1H4zm8 2a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H7a1 1 0 110-2h3V6a1 1 0 011-1z"/>
          </svg>
          <span class="text-sm text-gray-400">Suelta el archivo aquí o haz clic</span>
          <p id="file-name" class="text-sm text-gray-300 mt-2" style="display: none;"></p>
        </label>

        <!-- Vista previa de la imagen -->
        <img id="preview-image" class="mt-4 max-h-64 object-contain" style="display: none;" />

        {% if form.image.errors %}
          <p class="text-red-500 text-sm mt-2">{{ form.image.errors.0 }}</p>
        {% endif %}
      </div>
    </div>

    <!-- Columna derecha - Formulario 50% -->
    <div class="w-full lg:w-1/2 space-y-4">
      <div>
        <label for="id_title" class="block font-medium mb-1 text-black dark:text-white">
          Título <span class="text-red-600">*</span>
        </label>
        {{ form.title|add_class:"w-full p-3 rounded border border-gray-600 focus:outline-none focus:ring-2 focus:ring-pink-500 bg-white text-black dark:bg-gray-700 dark:text-white" }}
        {% if form.title.errors %}
          <p class="text-red-500 text-sm mt-1">{{ form.title.errors.0 }}</p>
        {% endif %}
      </div>

      <div>
        <label for="id_genre" class="block font-medium mb-1 text-black dark:text-white">
          Género
        </label>
        {{ form.genre|add_class:"w-full p-3 rounded border border-gray-600 focus:outline-none focus:ring-2 focus:ring-pink-500 bg-white dark:bg-gray-700 text-black dark:text-white custom-select" }}
        {% if form.genre.errors %}
          <p class="text-red-500 text-sm">{{ form.genre.errors.0 }}</p>
        {% endif %}
      </div>

      <div>
        <label for="id_content" class="block font-medium mb-1 text-black dark:text-white">
          Contenido <span class="text-red-600">*</span>
        </label>
        {{ form.content }}
        {% if form.content.errors %}
          <p class="text-red-500 text-sm mt-1">{{ form.content.errors.0 }}</p>
        {% endif %}
      </div>

      <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded mt-2 hover:bg-blue-700 transition-colors duration-300">
        Publicar
      </button>
    </div>
  </div>

  {{ form.media }}
</form>

<!-- Estilos -->
<style>
  .custom-select {
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    padding-right: 2.5rem;
    background-repeat: no-repeat;
    background-position: right 0.75rem center;
    background-size: 1.25rem;
    transition: background-color 0.4s ease, color 0.4s ease;
    color: inherit;
  }

  body:not(.dark) .custom-select {
    background-image: url("data:image/svg+xml,%3Csvg fill='black' height='20' viewBox='0 0 24 24' width='20' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
  }

  body.dark .custom-select {
    background-image: url("data:image/svg+xml,%3Csvg fill='white' height='20' viewBox='0 0 24 24' width='20' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
  }

  /* CKEditor claro/oscuro */
  body.dark .ck-editor__editable_inline {
    background-color: #1f2937 !important;
    color: white !important;
  }

  body:not(.dark) .ck-editor__editable_inline {
    background-color: white !important;
    color: black !important;
  }
</style>

<!-- Scripts -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Vista previa de imagen
    const input = document.getElementById("id_image");
    const preview = document.getElementById("preview-image");

    input.addEventListener("change", function () {
      const file = this.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          preview.src = e.target.result;
          preview.style.display = "block";
        };
        reader.readAsDataURL(file);
      } else {
        preview.src = "";
        preview.style.display = "none";
      }
    });

    // Ajuste de colores CKEditor
    const waitEditor = setInterval(() => {
      const editable = document.querySelector('.ck-editor__editable_inline');
      if (editable) {
        const applyTheme = () => {
          const isDark = document.body.classList.contains('dark');
          editable.style.backgroundColor = isDark ? '#1f2937' : '#ffffff';
          editable.style.color = isDark ? '#ffffff' : '#000000';
        };
        applyTheme();

        const observer = new MutationObserver(applyTheme);
        observer.observe(document.body, { attributes: true, attributeFilter: ['class'] });
        clearInterval(waitEditor);
      }
    }, 300);
  });
</script>

{% endblock %}
